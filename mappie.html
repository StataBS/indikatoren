<!DOCTYPE html>
<html lang="de">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MapPie</title>

    <style type="text/css">
        #container {
            min-width: 320px;
            max-width: 800px;
            height: 500px;
            margin: 1em auto;
        }
    </style>


  </head>

<body style="margin: 0;">
      
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.6/proj4.js"></script>      
    <script src="assets/js/modules/highcharts/highcharts.js"></script>
    <script src="assets/js/modules/highcharts/modules/map.js"></script>
    <script src="assets/js/modules/highcharts/modules/exporting.js"></script>
    <script src="geojson/wohnviertel_EPSG_2056.js"></script>    

    
    <div id="container"></div>

<script type="text/javascript">

/*  
    global Highcharts
    global geojson_wohnviertel
*/

// source: https://www.highcharts.com/blog/data-journalism/effectively-visualizing-us-election-results/, 
//  which displays  http://jsfiddle.net/gh/get/library/pure/highcharts/highcharts/tree/master/samples/maps/demo/map-pies/

    
// New map-pie series type that also allows lat/lon as center option.
// Also adds a sizeFormatter option to the series, to allow dynamic sizing
// of the pies.
Highcharts.seriesType('mappie', 'pie', {
    center: null, // Can't be array by default anymore
    clip: true, // For map navigation
    states: {
        hover: {
            halo: {
                size: 5
            }
        }
    },
    dataLabels: {
        enabled: false
    }
}, {
    getCenter: function () {
        var options = this.options,
            chart = this.chart,
            slicingRoom = 2 * (options.slicedOffset || 0);
        if (!options.center) {
            options.center = [null, null]; // Do the default here instead
        }
        // Handle lat/lon support
        if (options.center.lat !== undefined) {
            var point = chart.fromLatLonToPoint(options.center);
            options.center = [
                chart.xAxis[0].toPixels(point.x, true),
                chart.yAxis[0].toPixels(point.y, true)
            ];
        }
        // Handle dynamic size
        if (options.sizeFormatter) {
            options.size = options.sizeFormatter.call(this);
        }
        // Call parent function
        var result = Highcharts.seriesTypes.pie.prototype.getCenter.call(this);
        // Must correct for slicing room to get exact pixel pos
        result[0] -= slicingRoom;
        result[1] -= slicingRoom;
        return result;
    },
    translate: function (p) {
        this.options.center = this.userOptions.center;
        this.center = this.getCenter();
        return Highcharts.seriesTypes.pie.prototype.translate.call(this, p);
    }
});


var data = [
        // id, demVotes, repVotes, libVotes, grnVotes, sumVotes, winner, (wohnviertelid), offset config for pies
        ['Altstadt Grossbasel', 729547, 1318255, 44467, 9391, 2101660, -1, 1],
        ['Vorstädte', 116454, 163387, 18725, 5735, 304301, -1, 2],
        ['Am Ring', 1161167, 1252401, 106327, 34345, 2554240, -1, 3],
        ['Breite', 380494, 684782, 29829, 9473, 1104578, -1, 4],
        ['St. Alban', 8577206, 4390272, 467370, 271047, 13705895, 1, 5],
        ['Gundeldingen', 1338870, 1202484, 144121, 38437, 2723912, 1, 6],
        ['Bruderholz', 897572, 673215, 48676, 22841, 1642304, 1, 7],
        ['Bachletten', 235603, 185127, 14757, 6103, 441590, 1, 8],
        ['Gotthelf', 282830, 12723, 4906, 4258, 304717, 1, 9],
        ['Iselin', 4504975, 4617886, 207043, 64399, 9394303, -1, 10],
        ['St. Johann', 1877963, 2089104, 125306, 0, 4092373, -1, 11],
        ['Altstadt Kleinbasel', 266891, 128847, 15954, 12737, 424429, 1, 12],
        ['Clara', 189765, 409055, 28331, 8496, 635647, -1 , 13],
        ['Wettstein', 2977498, 2118179, 208682, 74112, 5378471, 1, 14],
        ['Hirzbrunnen', 1039126, 1557286, 133993, 7841, 2738246, -1, 15],
        ['Rosental', 653669, 800983, 59186, 11479, 1525317, -1, 16],
        ['Matthäus', 427005, 671018, 55406, 23506, 1176935, -1, 17],
        ['Klybeck', 628854, 1202971, 53752, 13913, 1899490, -1, 18],
        ['Kleinhüningen', 780154, 1178638, 37978, 14031, 2010801, -1, 19],
        ['Riehen', 352156, 332418, 37578, 13995, 736147, 1, 20],
        ['Bettingen', 1502820, 878615, 78225, 33380, 2493040, 1, 30],
        /*
        ['Massachusetts', 1995196, 1090893, 138018, 47661, 3271768, 1, { lon: 3 }],
        ['Michigan', 2268839, 2279543, 172136, 51463, 4771981, -1],
        ['Minnesota', 1367716, 1322951, 112972, 36985, 2840624, 1, { lon: -1, drawConnector: false }],
        ['Mississippi', 462127, 678284, 14411, 3595, 1158417, -1],
        ['Missouri', 1054889, 1585753, 96404, 25086, 2762132, -1],
        ['Montana', 174281, 273879, 28036, 7868, 484064, -1],
        ['Nebraska', 273185, 485372, 38746, 8337, 805640, -1],
        ['Nevada', 539260, 512058, 37384, 0, 1088702, 1],
        ['New Hampshire', 348526, 345790, 30694, 6465, 731475, 1],
        ['New Jersey', 1967444, 1509688, 72143, 37131, 3586406, 1, { lat: -1, lon: 1.2 }],
        ['New Mexico', 380923, 316134, 74544, 9797, 781398, 1],
        ['New York', 4145376, 2638135, 162273, 100110, 7045894, 1],
        ['North Carolina', 2169496, 2345235, 130021, 1038, 4645790, -1],
        ['North Dakota', 93758, 216794, 21434, 378, 332364, -1],
        ['Ohio', 2320596, 2776683, 174266, 44310, 5315855, -1],
        ['Oklahoma', 420375, 949136, 83481, 0, 1452992, -1],
        ['Oregon', 991580, 774080, 93875, 49247, 1908782, 1],
        ['Pennsylvania', 2874136, 2945302, 144826, 49334, 6013598, -1],
        ['Rhode Island', 227062, 166454, 14700, 6171, 414387, 1, { lat: -0.7, lon: 1.7 }],
        ['South Carolina', 855373, 1155389, 49204, 13034, 2073000, -1],
        ['South Dakota', 117442, 227701, 20845, 0, 365988, -1],
        ['Tennessee', 868853, 1519926, 70286, 15952, 2475017, -1],
        ['Texas', 3877868, 4685047, 283492, 71558, 8917965, -1],
        ['Utah', 222858, 375006, 39608, 7695, 645167, -1],
        ['Vermont', 178573, 95369, 10078, 6758, 290778, 1, { lat: 2 }],
        ['Virginia', 1981473, 1769443, 118274, 27638, 3896828, 1],
        ['Washington', 1727840, 1210370, 160356, 57571, 3156137, 1],
        ['West Virginia', 187519, 486304, 22958, 8016, 704797, -1],
        ['Wisconsin', 1382947, 1407028, 106470, 31016, 2927461, -1],
        ['Wyoming', 55973, 174419, 13287, 2515, 246194, -1]
        */
    ],
    maxVotes = 0,
    demColor = 'rgba(74,131,240,0.80)',
    repColor = 'rgba(220,71,71,0.80)',
    libColor = 'rgba(240,190,50,0.80)',
    grnColor = 'rgba(90,200,90,0.80)';


// Compute max votes to find relative sizes of bubbles
Highcharts.each(data, function (row) {
    maxVotes = Math.max(maxVotes, row[5]);
});

// Build the chart
var chart = Highcharts.mapChart('container', {
    title: {
        text: 'Map-Pie'
    },

    chart: {
        animation: false, // Disable animation, especially for zooming
        events: {
            load: function (e) {
                var chart = this;
                
                /*
                // When clicking legend items, also toggle connectors and pies
                Highcharts.each(chart.legend.allItems, function (item) {
                    var old = item.setVisible;
                    item.setVisible = function () {
                        var legendItem = this;
                        old.call(legendItem);
                        Highcharts.each(chart.series[0].points, function (point) {
                            if (chart.colorAxis[0].dataClasses[point.dataClass].name === legendItem.name) {
                                // Find this Wohnviertel's pie and set visibility
                                Highcharts.find(chart.series, function (item) {
                                    return item.name === point.id;
                                }).setVisible(legendItem.visible, false);
                                // Do the same for the connector point if it exists
                                var connector = Highcharts.find(chart.series[1].points, function (item) {
                                    return item.name === point.id;
                                });
                                if (connector) {
                                    connector.setVisible(legendItem.visible, false);
                                }
                            }
                        });
                        chart.redraw();
                    };
                });
                */
                
                
                
                // Add the pies after chart load, optionally with offset and connectors
                Highcharts.each(chart.series[0].points, function (wohnviertel) {
                    if (!wohnviertel.id) {
                        return; // Skip points with no data, if any
                    }
                
                    var pieOffset = wohnviertel.pieOffset || {},
                        centerLat = parseFloat(wohnviertel.properties.lat),
                        centerLon = parseFloat(wohnviertel.properties.lon);
                
                    var currentPieSeries = 
                    {
                        type: 'mappie',
                        //name: wohnviertel.id,
                        name: 'Pie-' + wohnviertel.wohnviertelid,
                        zIndex: 6, // Keep pies above connector lines
                        borderWidth: 0,
                        sizeFormatter: function () {
                            var yAxis = this.chart.yAxis[0],
                                zoomFactor = (yAxis.dataMax - yAxis.dataMin) /
                                    (yAxis.max - yAxis.min);
                            return Math.max(
                                this.chart.chartWidth / 45 * zoomFactor, // Min size
                                this.chart.chartWidth / 11 * zoomFactor * wohnviertel.value / maxVotes
                            );
                        },
                        
                        tooltip: {
                            // Use the wohnviertel tooltip for the pies as well
                            pointFormatter: function () {
                                return wohnviertel.series.tooltipOptions.pointFormatter.call({
                                    id: wohnviertel.id,
                                    hoverVotes: this.name,
                                    demVotes: wohnviertel.demVotes,
                                    repVotes: wohnviertel.repVotes,
                                    libVotes: wohnviertel.libVotes,
                                    grnVotes: wohnviertel.grnVotes,
                                    sumVotes: wohnviertel.value
                                });
                            }
                        },
                        data: [{
                            name: 'FDP',
                            y: wohnviertel.demVotes,
                            color: demColor
                        }, {
                            name: 'SP',
                            y: wohnviertel.repVotes,
                            color: repColor
                        }, {
                            name: 'CVP',
                            y: wohnviertel.libVotes,
                            color: libColor
                        }, {
                            name: 'Grüne',
                            y: wohnviertel.grnVotes,
                            color: grnColor
                        }],
                
                        center: {
                            lat: centerLat + (pieOffset.lat || 0),
                            lon: centerLon + (pieOffset.lon || 0)
                        }
                    }
                    ;
                    
                    // Add the pie for this wohnviertel
                    chart.addSeries(currentPieSeries, false);
                    
                    /*
                    // Draw connector to wohnviertel center if the pie has been offset
                    if (pieOffset.drawConnector !== false) {
                        var centerPoint = chart.fromLatLonToPoint({
                                lat: centerLat,
                                lon: centerLon
                            }),
                            offsetPoint = chart.fromLatLonToPoint({
                                lat: centerLat + (pieOffset.lat || 0),
                                lon: centerLon + (pieOffset.lon || 0)
                            });
                        chart.series[1].addPoint({
                            name: wohnviertel.id,
                            path: 'M' + offsetPoint.x + ' ' + offsetPoint.y +
                                'L' + centerPoint.x + ' ' + centerPoint.y
                        }, false);
                    }
                    */
                    
                    //console.log(chart.series[chart.series.length-1]);
                    
                });
                // Only redraw once all pies and connectors have been added
                chart.redraw();
            }
        }
    },
    
    
    colorAxis: {
        /*
        dataClasses: [{
            from: -1,
            to: 0,
            color: 'rgba(244,91,91,0.5)',
            name: 'SP' //'Republican'
        }, {
            from: 0,
            to: 1,
            color: 'rgba(124,181,236,0.5)',
            name: 'FDP'//'Democrat'
        }, {
            from: 2,
            to: 3,
            color: libColor,
            name: 'CVP'//'Libertarian',
            
        }, {
            from: 3,
            to: 4,
            color: grnColor,
            name: 'Grüne Partei'//'Green',
        }]
        */
    },
    
    legend: {},
    
    mapNavigation: {
        enabled: true
    },
    // Limit zoom range
    yAxis: {
        //minRange: 2300
    },

    tooltip: {
        useHTML: true
    },

    // Default options for the pies
    plotOptions: {
        mappie: {
            borderColor: 'rgba(255,255,255,0.4)',
            borderWidth: 1,
            tooltip: {
                headerFormat: ''
            }
        }
    },

    series: [{
        mapData: geojson_wohnviertelEPSG2056, 
        data: data,
        name: 'Wohnviertel',
        borderColor: '#FFF',
        showInLegend: true,
        showCheckbox: true, 
        //joinBy: ['name', 'id'],
        joinBy: ['TXT', 'wohnviertelid'],
        keys: ['id', 'demVotes', 'repVotes', 'libVotes', 'grnVotes', 'value', 'winner', 'wohnviertelid', 'pieOffset'],
        tooltip: {
            headerFormat: '',
            pointFormatter: function () {
                var hoverVotes = this.hoverVotes; // Used by pie only
                return '<b>' + this.id + '</b><br/>Wählerstimmen pro Wohnviertel:<br/>' +
                    Highcharts.map([
                        ['FDP', this.demVotes, demColor],
                        ['SP', this.repVotes, repColor],
                        ['CVP', this.libVotes, libColor],
                        ['Grüne', this.grnVotes, grnColor]
                    ].sort(function (a, b) {
                        return b[1] - a[1]; // Sort tooltip by most votes
                    }), function (line) {
                        return '<span style="color:' + line[2] +
                            // Colorized bullet
                            '">\u25CF</span> ' +
                            // Party and votes
                            (line[0] === hoverVotes ? '<b>' : '') +
                            line[0] + ': ' +
                            Highcharts.numberFormat(line[1], 0) +
                            (line[0] === hoverVotes ? '</b>' : '') +
                            '<br/>';
                    }).join('') +
                    '<hr/>Total: ' + Highcharts.numberFormat(this.sumVotes, 0);
            }
        }
    }, {
        name: 'Connectors',
        type: 'mapline',
        color: 'rgba(130, 130, 130, 0.5)',
        zIndex: 5,
        showInLegend: true,
        enableMouseTracking: false
    }]
});



</script>

</body>
