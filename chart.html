<!DOCTYPE html>
<html lang="de">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Indikator</title>

    <style type="text/css">
      a {
        text-decoration: none;
        color: inherit;
      }

      #container .highcharts-container {
        margin: 0 auto;
      }
    </style>

    <link href="assets/bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css">   
    <link href="assets/css/indikatoren-filter.css" media="screen" rel="stylesheet" type="text/css">
    <script src="assets/js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="assets/js/url-min.js" type="text/javascript"></script>
    <script src="node_modules/highcharts/highcharts.js" type="text/javascript"></script>
    <script src="node_modules/highcharts/highcharts-more.js" type="text/javascript"></script>    
    <script src="node_modules/highcharts/modules/data.js" type="text/javascript"></script>
    <script src="node_modules/highcharts/modules/map.js" type="text/javascript"></script>
	  <script src="node_modules/highcharts/modules/exporting.js" type="text/javascript"></script>    
      
    <!--script src="assets/js/highcharts-offline-exporting-4.2.6.js" type="text/javascript" ></script-->
    <script src="metadata/all/kuerzelById.js" type="text/javascript"></script>
    <script src="metadata/all/idByKuerzel.js" type="text/javascript"></script>
    <script src="metadata/all/templatesById.js" type="text/javascript"></script>
    <script src="assets/js/indikatoren-highcharts.js" type="text/javascript"></script>
    <script src='geojson/wohnviertel_reproj_mollweide_simp.js' type="text/javascript"></script>


  </head>

  <body style="margin: 0;">
    <!-- Google Tag Manager -->
    <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-KGK459"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KGK459');</script>
    <!-- End Google Tag Manager -->


    <script type="text/javascript">
    
        /*  
        global $
        global jQuery
        global indikatoren
        global idByKuerzel
        global kuerzelById
        global lazyRenderChartById
        global exportThumbnail
        */
        
        //get kuerzel and id from url, encode to prevent xss 
        //todo: in order to prevent xss: do not evaluate chart templates but just load json. Functions need to be taken out of the templates. 
        var kuerzel = window.decodeURIComponent($.url('?kuerzel'));              
        var id = window.decodeURIComponent($.url('?id'));    

        //check if kuerzel or id is member in the list of existing charts
        if (idByKuerzel[kuerzel] || kuerzelById[id]){
          var chartOptions = {};                  
          //if no id is given, retrieve it using kuerzel (and same for kuerzel)
          if (id == 'undefined') {
            id = idByKuerzel[kuerzel]
          };
          if (kuerzel == 'undefined') {
            kuerzel = kuerzelById[id]
          };
          $.getScript('metadata/single/'+ id + '.js').done(function(script, textStatus){              
              var chartMetadata = indikatoren[0];
              //create div for chart
              jQuery('<div/>', {
                id: 'container-' + id,
              }).appendTo('body');
            

              //check if chart needs to be exported, and how
              var exportType = window.decodeURIComponent($.url('?thumbnailType'));

              var chartOptions = {};            
              var indikatorensetView = (window.decodeURIComponent($.url('?indikatorensetView')) === 'true') ? true : false;
              lazyRenderChartById(id, chartMetadata, indikatorensetView, function(){
                
                //make sure we have the complete chart with the renderTo object, which contains the kuerzel
                if (this.renderTo){                        
                  //determine if offline exporting necessary
                  var thumbnailOfflineExporting = (window.decodeURIComponent($.url('?thumbnailOfflineExporting')) === "true") ? true : false ;                
                  //load offline exporting module first if required, then invoke createThumbnail()
                  (thumbnailOfflineExporting) ? $.getScript('assets/js/highcharts-offline-exporting-4.2.6.js', function(){createThumbnail(id, kuerzel, exportType, thumbnailOfflineExporting)}) : createThumbnail(id, kuerzel, exportType, thumbnailOfflineExporting);
                }                     
              });
          })

      }
      else {
        //display error message
        $('body').append('<div class="container"><div class="jumbotron"><h1>Ooops...</h1><p>Kein Chart mit diesem Kürzel bzw. dieser id gefunden.</p></div></div>');
      }
      
      
      function createThumbnail(id, kuerzel, exportType, thumbnailOfflineExporting){                  
        switch (exportType){
          case "jpg":                 
            exportThumbnail(id, "image/jpeg", thumbnailOfflineExporting);                     
            break;                    
          case "png": 
            exportThumbnail(id, "image/png", thumbnailOfflineExporting);
            break;
          case "svg":              
            exportThumbnail(id, "image/svg+xml", thumbnailOfflineExporting);
            break;           
        }
      }
      
    </script>
  </body>
</html>
